---
title: "SAtl_Climate_MSE_Results - Red Porgy Overages"
author: "Cassidy Peterson"
date: "July 2023"
output: html_document
---

```{r setup, include=FALSE}
# library(knitr)
knitr::opts_chunk$set(echo = TRUE, autodep = TRUE)#, cache=TRUE)
# knitr::opts_knit$set(root.dir="..")
setwd('C:\\Users\\cassidy.peterson\\Documents\\Github\\SAtl_Climate_MSE')
# library(openMSE)
# library(vioplot)
source("Analyze_Results_Setup.R")

```

## Background

Here are the results from a South Atlantic MSE exercise testing the behavior of model-based versus empirical MPs for black sea bass (BSB), vermilion snapper (VS), and red porgy (RP) using the openMSE software ([Blue Matter Science](bluematterscience.com)).

Below are the results for RP with implementation overages (RP_O). 


## RP_Overages Results

```{r RP-FOUNDATION, setup, include=FALSE, cache=TRUE, cache.lazy=FALSE}
# knitr::opts_chunk$set(cache = TRUE) # do not re-run if unnecessary

##### INPUTS ######
set.file<-"MSE_obj/"
# species<-"RedPorgy"; sp<-"RP"
# species<-"VermilionSnapper"; sp<-"VS"
# species<-"BlackSeaBass"; sp<-"BSB"
species<-"RedPorgy_Over"; sp<-"RP_O"
# species<-"VermilionSnapper_Over"; sp<-"VS_O"
# species<-"BlackSeaBass_Over"; sp<-"BSB_O"


orderedMPs<- c(1:2, 12:13, 3:11) #c(1, 10:11, 2:9, 12:13) #c(1, 9:10, 2:8)
orderedScenarios<-c(3, 5,6,4,1,2,7,10,11,8,9) #c(3,5:6,4,1:2,7:11)
scenarios<-c("base","recdev_hi", "recdev_lo", "epiM", "age0M_hi", "age0M_lo",
             "recns", "uobs_hi", "uobs_lo", "refbias_hi",  "refbias_lo")

MP_namesR_leg<-c("ZeroC","SCA1","SCA5_c","SCA10_c","SCA5_p","SCA10_p",
                     "GBtarg","ICI","Irat","IT10","Itarg",
                     "GBslope","Islope")
MP_namesR_abbrev<-c("ZC","S1","5c","10c","5p","10p", "GBt",
                        "ICI","Ir","I10","It","GBs","Is")

MP_R_col=c('grey15','grey30','gray40','gray50','gray60','gray70','deepskyblue4','deepskyblue3','deepskyblue','lightskyblue1','lightskyblue', 'lightseagreen','cadetblue','cadetblue1')

# par.args<-list(mar=c(2.4, 2.4, 0.2, 0.2), mgp=c(1.1, 0.25, 0), tck=-0.01, cex.axis=1)
par.args<-list(mar=c(0.5, 0.5, 0.2, 0.2), mgp=c(0.7, 0.25, 0), tck=-0.01, cex.axis=1)
par(par.args)



### Run FUNCTIONS for input species #####
assign(sp, GetResults(species1=species,sp1=sp)) # save GetResults with sp | SP

# correct results for EpiM SSB nonsensical results
sptemp<-get(sp)                       # save SP as sptemp
summary(sptemp$epiM@SB_SBMSY)         # see nonsensical sptemp results
assign(sp, EpiMDeal(sptemp))          # deal with nonsensical results -- resave as SP
summary(get(sp)$epiM@SB_SBMSY)        # see updated results

# Get performance metrics and reorder
CollatePMs_temp<-CollatePMs(sp)
assign(paste(sp,"PMs",sep='_'), CollatePMs_temp$returnlist) #SP_PMs -- UNORDERED
assign(paste(sp, "PM", sep="_"), Reorder_MPs(get(paste0(sp,"_PMs"))) ) #SP_PM ## REORDERED PERF METRICS
assign(paste(sp, "PMs_nest", sep="_"), CollatePMs_temp$returnlist_nest ) #SP_PMs_nested -- UNORDERED ##
assign(paste(sp, "PM_nest", sep="_"), Reorder_MPs(get(paste0(sp,"_PMs_nest")), nested=TRUE) ) #SP_PM ## REORDERED PERF METRICS REORDERED PERF METRICS

# Get performance metrics relative to base OM case
assign(paste(sp,"RelPM_rd", sep='_'), Relative_MP_Perf_rd(sp)) #SP_RelPM_rd
# 
# # temp<-get(sp); temp_PM<-get(paste(sp, "PM", sep="_")); temp_PM_nest<-get(paste(sp, "PM_nest", sep="_"))
# # save(temp, file="SP_temp.RData")
# # save(temp_PM, file="SP_PMs.RData")
# # save(temp_PM_nest, file="SP_PMs_nest.RData")
```



#### Median Trajectory Plots

```{r echo=FALSE, fig.height=9,  fig.cap = "Median SSB / dynSSB0 trajectories"}
# exercise.setup="PreviousChunk",
par(mfrow=c(4,3), mar=c(2.4, 2.4, 0.2, 0.2), mgp=c(1.1, 0.25, 0), tck=-0.01, cex.axis=1)
reflinetemp<-get(sp)[[1]]@OM$SSBMSY_SSB0[1]
Plot_SSBtraj_dSSB0(fsh=sp, refline=reflinetemp, subset=c(1:13))

```


```{r echo=FALSE, fig.height=9, fig.cap = "Median SSB / dynSSB0 trajectories for model MPs"}

par(mfrow=c(4,3), mar=c(2.4, 2.4, 0.2, 0.2), mgp=c(1.1, 0.25, 0), tck=-0.01, cex.axis=1)
reflinetemp<-get(sp)[[1]]@OM$SSBMSY_SSB0[1]
Plot_SSBtraj_dSSB0(fsh=sp, refline=reflinetemp, subset=c(2,7:13),#subset=c(1,8:13),
                   colsR=c('black','deepskyblue','deeppink','darkolivegreen3','darkorchid','darkorange','steelblue', 'orchid'))
# ,'blue','pink','green','orchid','cyan'))

```

```{r echo=FALSE, fig.height=9, fig.cap = "Median SSB / dynSSB0 trajectories for empirical MPs"}

par(mfrow=c(4,3), mar=c(2.4, 2.4, 0.2, 0.2), mgp=c(1.1, 0.25, 0), tck=-0.01, cex.axis=1)
reflinetemp<-get(sp)[[1]]@OM$SSBMSY_SSB0[1]
Plot_SSBtraj_dSSB0(fsh=sp, refline=reflinetemp, subset=c(2:6),
                   colsR=c('black','deepskyblue','steelblue','deeppink','darkorange'))

```

```{r echo=FALSE, fig.height=9,  fig.cap = "Median SSB / static SSBMSY trajectories"}
par(mfrow=c(4,3), mar=c(2.4, 2.4, 0.2, 0.2), mgp=c(1.1, 0.25, 0), tck=-0.01, cex.axis=1)
Plot_SSBtraj_MSY(fsh=sp)

```

```{r echo=FALSE, fig.height=9,  fig.cap = "Median catch trajectories"}

par(mfrow=c(4,3), mar=c(2.4, 2.4, 0.2, 0.2), mgp=c(1.1, 0.25, 0), tck=-0.01, cex.axis=1)
Plot_Catchtraj(fsh=sp, subset=c(2:13))

```




#### Biomass Performance Metrics
```{r RP_0-biomass-PM, echo=FALSE, fig.height=7, fig.width=9, fig.cap = "OM-specific MP biomass performance"}

par(mfrow=c(3,4), mar=c(2.4, 2.4, 0.2, 0.2), mgp=c(1.1, 0.25, 0), tck=-0.01, cex.axis=1)
reflinetemp<-get(sp)[[1]]@OM$SSBMSY_SSB0[1]

myPlot_Violin(get(paste0(sp,"_PM_nest")), stat='treldSSB0', ylims=c(0,1.1), refline2=reflinetemp)
 PlotRelPM(sp, calc='rd', Pstat='treldSSB0',
            baserefline=c(1,reflinetemp), refline=0,
            maxylim=c(1.1, 300, -0.5, 1, -0.0, 30, 10, 3, 35, 4, 5), #RP
            minylim=c(0, rep(-1.05,10))) ## PLEASE NOTE THAT OUTLIERS HAVE BEEN CUT OFF
 
 
myPlot_Violin(get(paste0(sp,"_PM_nest")), stat='t10reldSSB0', ylims=c(0,1.1), refline2=reflinetemp)
  PlotRelPM(sp, calc='rd', Pstat='t10reldSSB0',
            baserefline=c(1, reflinetemp), refline=0,
            maxylim=c(1.1, 100, -0.5, 1, -0.0, 15, 3, 2, 35, 4, 4), #RP
            minylim=c(0, rep(-1.05,10)) ) ## PLEASE NOTE THAT OUTLIERS HAVE BEEN CUT OFF
  
  
myPlot_Violin(get(paste0(sp,"_PM_nest")), stat='P100', ylims=c(0,1.1), refline2=0.5)
  PlotRelPM(sp, calc='rd', Pstat='P100',
            baserefline=1, refline=0,
            maxylim=c(1.1, 10, 0.1, 0.1, 0.1, 30, 2, 3, 35, 2.5, 2.5), #RP
            minylim=c(0, rep(-1.05,10)) ) ## PLEASE NOTE THAT OUTLIERS HAVE BEEN CUT OFF

```
#### Fishing mortality metrics
```{r RP_0-F-PM, echo=FALSE, warning=FALSE, fig.height=7, fig.width=9, fig.cap = "OM-specific MP fishing mortality performance"}

par(mfrow=c(3,4), mar=c(2.4, 2.4, 0.2, 0.2), mgp=c(1.1, 0.25, 0), tck=-0.01, cex.axis=1)

myPlot_Violin(get(paste0(sp,"_PM_nest")), stat='trelF', ylimsEpiM=c(0,4))
PlotRelPM(sp, calc='rd', Pstat='trelF',
            baserefline=1, refline=0,
            maxylim=c(10, 5, 50, 50, 150, 2.5, 3, 50, 1.5, 10, 5), #RP
            minylim=c(0, rep(-1.05,10)) ) ## PLEASE NOTE THAT OUTLIERS HAVE BEEN CUT OFF

myPlot_Violin(get(paste0(sp,"_PM_nest")), stat='t10relF', ylimsEpiM=c(0,4))
 PlotRelPM(sp, calc='rd', Pstat='t10relF',           ### NOTE THAT relF is arbitrarily set to 100 where F/FMSY == INF
            baserefline=1, refline=0,
            maxylim=c(10, 3, 50, 150, 150, 1.5, 3, 50, 5, 10, 5), # RP
            minylim=c(0, rep(-1.05,10)) ) ## PLEASE NOTE THAT OUTLIERS HAVE BEEN CUT OFF
 
myPlot_Violin(get(paste0(sp,"_PM_nest")), stat='PNOF', ylims=c(0,1.1), refline2=0.5)
PlotRelPM(sp, calc='rd', Pstat='PNOF',
            baserefline=1, refline=0,
            maxylim=c(1.1, 10, 0.1, 0.1, 0.1, 30, 2, 3, 35, 2.5, 2.5), #RP
            minylim=c(0, rep(-1.05,10)) ) ## PLEASE NOTE THAT OUTLIERS HAVE BEEN CUT OFF



```

#### Yield metrics
```{r RP_0-yield-plots, echo=FALSE, fig.height=7, fig.width=9, fig.cap = "OM-specific MP yield performance"}

par(mfrow=c(3,4), mar=c(2.4, 2.4, 0.2, 0.2), mgp=c(1.1, 0.25, 0), tck=-0.01, cex.axis=1)

myPlot_Violin(get(paste0(sp,"_PM_nest")), stat='AAVY', ylims=c(0,1.5))
myPlot_Violin(get(paste0(sp,"_PM_nest")), stat='tyield', ylims=c(0,3))
myPlot_Violin(get(paste0(sp,"_PM_nest")), stat='cyield', refline2=50, ylims=c(0,150))
PlotRelPM(sp, calc='rd', Pstat='cyield',
            baserefline=50, refline=0,
            maxylim=c(80, 0.5, 10, 1.5,6, 1, 4, 3, 2, 4, 2), #RP
            minylim=c(0, rep(-1.05,10)) ) ## PLEASE NOTE THAT OUTLIERS HAVE BEEN CUT OFF
Plot_my_tyield(SPP=get(sp), ylims=c(0,5000))
Plot_my_cyield(SPP=get(sp), ylims=c(0, 150000))

```

#### Cumulative Performance Metrics
```{r RP_0-cumulative-PM-plot, echo=FALSE, fig.height=5, fig.cap = "MP performance across OMs"}

par(mfrow=c(2,3), mar=c(2.4, 2.4, 0.2, 0.2), mgp=c(1.1, 0.25, 0), tck=-0.01, cex.axis=1)
reflinetemp<-get(sp)[[1]]@OM$SSBMSY_SSB0[1]
PlotCumPM(sp, Pstat="AAVY", refline=c(0.3), title=species, ylims=c(0,1)) # for BSB_O ylims=c(0,5) |for VS ylims=c(0,5)
PlotCumPM(sp, Pstat="PNOF", refline=c(0.5), title=species, ylims=c(0,1.1))
PlotCumPM(sp, Pstat="P100", refline=c(0.5), title=species, ylims=c(0,1.1))
PlotCumPM(sp, Pstat="treldSSB0", ylim=c(0,1.1), refline=c(1, reflinetemp), title=species)
PlotCumPM(sp, Pstat="t10reldSSB0", ylim=c(0,1.1), refline=c(1, reflinetemp), title=species)
PlotCumPM(sp, Pstat="cyield",  refline=c(50), title=species, ylims=c(0, 150))
```

#### Trade off plots
```{r RP_0-trade-off-plots, echo=FALSE, fig.height=5, fig.cap = "MP performance across OMs"}
### Tradeoff plot
spp_pm<-get(paste(sp, "PM", sep="_"))

par(mfrow=c(1,2), mar=c(2.4, 2.4, 0.2, 0.2), mgp=c(1.1, 0.25, 0), tck=-0.01, cex.axis=1)
reflinetemp<-get(sp)[[1]]@OM$SSBMSY_SSB0[1]
TOff_Plot(SPP_PM=spp_pm, PMy='PNOF', PMx='cyield', errbars=F); abline(h=0.7, lty=3); abline(v=50, lty=2)
TOff_Plot(SPP_PM=spp_pm, PMy='t10reldSSB0', PMx='AAVY', errbars=F); abline(h=reflinetemp, lty=2); abline(v=0.3, lty=2)


```


#### Worm plots
```{r RP_0-worm-plots, echo=FALSE, fig.height=5, fig.cap = "MP performance across OMs"}
nms<-get(sp)$base@MPs
# cbind(MP_namesR_leg,orderedMPs)
mpnms<-nms[c(2,8,9)]
# names(get(sp))

# par(mfrow=c(1,4))
# myWorm(sp, OM="base", MPs=mpnms, metric="SB_SBMSY")
par(mfrow=c(3,3), oma=c(0,1.2,1.2,0), mar=c(2.4, 2.4, 0.2, 0.2), mgp=c(1.1, 0.25, 0), tck=-0.01, cex.axis=1)
myWorm(sp, OM="base", MPs=mpnms, metric="SB_SBMSY", nworms=9)
mtext(species, 3, outer=TRUE, line=-0.3)
par(mfrow=c(3,3), oma=c(0,0,1.2,0), mar=c(2.4, 3.4, 0.2, 0.2), mgp=c(1.1, 0.25, 0), tck=-0.01, cex.axis=1)
myWorm(sp, OM="base", MPs=mpnms, metric="SB_SBMSY", byMP=T, nworms=5)
myWorm(sp, OM="recdev_lo", MPs=mpnms, metric="SB_SBMSY", byMP=T, nworms=5)
myWorm(sp, OM="epiM", MPs=mpnms, metric="SB_SBMSY", byMP=T, nworms=5)
mtext(species, 3, outer=TRUE, line=0)


```


#### Other
Compare observed indices in uobs_hi and uobs_lo scenarios. Note that when index observation error increases, observed index values reach greater values, indicating a higher relative abundance. This translates to higher TACs and higher fishing pressure, resulting in lower abundances. 

```{r RP_0-indices-plots, echo=FALSE, fig.height=5, fig.cap = "Observed indices of abundance"}
base<-get(sp)[["base"]]
uobsHi<-get(sp)[["uobs_hi"]]
uobsLo<-get(sp)[["uobs_lo"]]
par(mfrow=c(4,3), oma=c(0,1.2,1.2,0), mar=c(2.4, 2.4, 0.2, 0.2), mgp=c(1.1, 0.25, 0), tck=-0.01, cex.axis=1)
for(i in 100:111){
  plot(uobsHi@PPD$SCA_1@AddInd[i,1,], type='l', col='red', ylab="Index",xlab="Year")
  lines(uobsLo@PPD$SCA_1@AddInd[i,1,], type='l', col='deepskyblue')
  lines(base@PPD$SCA_1@AddInd[i,1,], type='l')
}

par(mfrow=c(1,2))
boxplot(c(uobsHi@PPD$SCA_1@AddInd[,1,59:88]), c(base@PPD$SCA_1@AddInd[,1,59:88]), c(uobsLo@PPD$SCA_1@AddInd[,1,59:88]), 
        col=c('red','grey','deepskyblue'),ylab="Index (last 30 years)", names=c("uobs_Hi","base","uobs_Lo"))
boxplot(c(uobsHi@TAC[,2,21:50]), c(base@TAC[,2,21:50]), c(uobsLo@TAC[,2,21:50]), 
        col=c('red','grey','deepskyblue'),ylab="TAC (last 30 years)", ylim=c(0,7500), names=c("uobs_Hi","base","uobs_Lo"))
```
