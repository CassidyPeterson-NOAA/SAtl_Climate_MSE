---
title: "SAtl_Climate_MSE_Results"
author: "Cassidy Peterson"
date: "2/28/2023"
output: html_document
---

```{r setup, include=FALSE}
# library(knitr)
knitr::opts_chunk$set(echo = TRUE, autodep = TRUE)#, cache=TRUE)
# library(openMSE)
# library(vioplot)
source("Analyze_Results_Setup.R")

```

## Background

Here are the results from a South Atlantic MSE exercise testing the behavior of model-based versus empirical MPs for black sea bass (BSB), vermilion snapper (VS), and red porgy (RP) using the openMSE software ([Blue Matter Science](bluematterscience.com)).



## VS Results

```{r VS-FOUNDATION, setup, include=FALSE, cache=TRUE, cache.lazy=FALSE}
# knitr::opts_chunk$set(cache = TRUE) # do not re-run if unnecessary

##### INPUTS ######
set.file<-"MSE_obj/"
species<-"VermilionSnapper"; sp<-"VS"

abbrev=TRUE # true to select best performing MP configurations for each species. false to show all MP results.

orderedMPs<- c(1, 15:16, 2:14) #c(1, 10:11, 2:9, 12:13) #c(1, 9:10, 2:8)
orderedScenarios<-c(3, 5,6,4,1,2,7,10,11,8,9) #c(3,5:6,4,1:2,7:11)
scenarios<-c("base","recdev_hi", "recdev_lo", "epiM", "age0M_hi", "age0M_lo",
             "recns", "uobs_hi", "uobs_lo", "refbias_hi",  "refbias_lo")
# get(sp)$base@MPs
if(sp=="VS" | sp=="VS_O") {
  if(abbrev==TRUE){
    # VS: GB_targ_VS2 | myItarget_VS2? | GB_slope_VS | GB_Islope2
    orderedMPs<-c(1,15:16,2:3,5:8,10:11,14)
    MP_namesR_leg<-c("SCA1","SCA5_c","SCA10_c","SCA5_p","SCA10_p",
                     "GBtarg","ICI","Irat","IT10","Itarg",
                     "GBslope","Islope")
    MP_namesR_abbrev<-c("S1","5c","10c","5p","10p", "GBt",
                        "ICI","Ira","I10","Ita","GBs","Isl")
  }#end if abbrev==TRUE

  if(abbrev==FALSE){
    MP_namesR_leg<-c("SCA1","SCA5_c","SCA10_c","SCA5_p","SCA10_p",
                     "GBtarg","GBtarg2","ICI","Irat","IT10","Itarg","Itarg2",
                     "GBslope","GBslope2","Islope","Islope2")
    MP_namesR_abbrev<-c("S1","5c","10c","5p","10p", "GBt","Gt2",
                        "ICI","Ira","I10","Ita","It2","GBs","Gs2","Isl","Is2")
  }#end if abbrev==False
} # end if sp==VS



if(abbrev==FALSE){
  MP_R_col=c('grey30','gray40','gray50','gray60','gray70','deepskyblue4','deepskyblue3','deepskyblue','lightskyblue1','lightskyblue','cadetblue','cadetblue1','cadetblue3', 'lightseagreen','mediumseagreen', 'aquamarine','aquamarine3')
}
if(abbrev==TRUE){
  MP_R_col=c('grey30','gray40','gray50','gray60','gray70','deepskyblue4','deepskyblue3','deepskyblue','lightskyblue1','lightskyblue', 'lightseagreen','cadetblue','cadetblue1')
}

# par.args<-list(mar=c(2.4, 2.4, 0.2, 0.2), mgp=c(1.1, 0.25, 0), tck=-0.01, cex.axis=1)
par.args<-list(mar=c(0.5, 0.5, 0.2, 0.2), mgp=c(0.7, 0.25, 0), tck=-0.01, cex.axis=1)
par(par.args)


### Run FUNCTIONS for input species #####
assign(sp, GetResults(species1=species,sp1=sp)) # save GetResults with sp | SP

# correct results for EpiM SSB nonsensical results
sptemp<-get(sp)                       # save SP as sptemp
summary(sptemp$epiM@SB_SBMSY)         # see nonsensical sptemp results
assign(sp, EpiMDeal(sptemp))          # deal with nonsensical results -- resave as SP
summary(get(sp)$epiM@SB_SBMSY)        # see updated results

# Get performance metrics and reorder
CollatePMs_temp<-CollatePMs(sp)
assign(paste(sp,"PMs",sep='_'), CollatePMs_temp$returnlist) #SP_PMs -- UNORDERED
assign(paste(sp, "PM", sep="_"), Reorder_MPs(get(paste0(sp,"_PMs"))) ) #SP_PM ## REORDERED PERF METRICS
assign(paste(sp, "PMs_nest", sep="_"), CollatePMs_temp$returnlist_nest ) #SP_PMs_nested -- UNORDERED ##
assign(paste(sp, "PM_nest", sep="_"), Reorder_MPs(get(paste0(sp,"_PMs_nest")), nested=TRUE) ) #SP_PM ## REORDERED PERF METRICS REORDERED PERF METRICS

# Get performance metrics relative to base OM case
assign(paste(sp,"RelPM_rd", sep='_'), Relative_MP_Perf_rd(sp)) #SP_RelPM_rd

```


#### Median Trajectory Plots

```{r echo=FALSE,   fig.cap = "Median SSB / dynSSB0 trajectories"}
# exercise.setup="PreviousChunk",
par(mfrow=c(4,3), mar=c(2.4, 2.4, 0.2, 0.2), mgp=c(1.1, 0.25, 0), tck=-0.01, cex.axis=1)
reflinetemp<-get(sp)[[1]]@OM$SSBMSY_SSB0[1]
Plot_SSBtraj_dSSB0(fsh=sp, refline=reflinetemp)

```


```{r echo=FALSE, fig.cap = "Median SSB / dynSSB0 trajectories for model MPs"}

par(mfrow=c(4,3), mar=c(2.4, 2.4, 0.2, 0.2), mgp=c(1.1, 0.25, 0), tck=-0.01, cex.axis=1)
reflinetemp<-get(sp)[[1]]@OM$SSBMSY_SSB0[1]
Plot_SSBtraj_dSSB0(fsh=sp, refline=reflinetemp, subset=c(1:5),
                   colsR=c('black','deepskyblue','steelblue','deeppink','darkorange'))

```

```{r echo=FALSE,  fig.cap = "Median SSB / dynSSB0 trajectories for empirical MPs"}

par(mfrow=c(4,3), mar=c(2.4, 2.4, 0.2, 0.2), mgp=c(1.1, 0.25, 0), tck=-0.01, cex.axis=1)
reflinetemp<-get(sp)[[1]]@OM$SSBMSY_SSB0[1]
Plot_SSBtraj_dSSB0(fsh=sp, refline=reflinetemp, subset=c(1,6:12),#subset=c(1,8:13),
                   colsR=c('black','deepskyblue','deeppink','darkolivegreen3','darkorchid','darkorange','steelblue', 'orchid'))
# ,'blue','pink','green','orchid','cyan'))


```

```{r echo=FALSE,  fig.cap = "Median SSB / dynSSB0 trajectories for empirical MPs"}

par(mfrow=c(4,3), mar=c(2.4, 2.4, 0.2, 0.2), mgp=c(1.1, 0.25, 0), tck=-0.01, cex.axis=1)
Plot_Catchtraj(fsh=sp)

```



#### Biomass Performance Metrics
```{r VS-biomass-PM, echo=FALSE, fig.height=7, fig.width=9, fig.cap = "OM-specific MP biomass performance"}

par(mfrow=c(3,4), mar=c(2.4, 2.4, 0.2, 0.2), mgp=c(1.1, 0.25, 0), tck=-0.01, cex.axis=1)
reflinetemp<-get(sp)[[1]]@OM$SSBMSY_SSB0[1]

myPlot_Violin(get(paste0(sp,"_PM_nest")), stat='treldSSB0', ylims=c(0,1.1), refline2=reflinetemp)
 PlotRelPM(sp, calc='rd', Pstat='treldSSB0',
            baserefline=c(1,reflinetemp), refline=0,
            maxylim=c(1.1, 3, 0.5, 1, 1, 2, 2, 3.5, 5, 4, 5), #VS
            minylim=c(0, rep(-1.05,10)) ) ## PLEASE NOTE THAT OUTLIERS HAVE BEEN CUT OFF
 
 
myPlot_Violin(get(paste0(sp,"_PM_nest")), stat='t10reldSSB0', ylims=c(0,1.1), refline2=reflinetemp)
  PlotRelPM(sp, calc='rd', Pstat='t10reldSSB0',
            baserefline=c(1,reflinetemp), refline=0,
            maxylim=c(1.1, 3, 0.5, 1, 1, 2, 2, 3.5, 5, 4, 5), #VS
            minylim=c(0, rep(-1,10)) ) ## PLEASE NOTE THAT OUTLIERS HAVE BEEN CUT OFF
  
  
myPlot_Violin(get(paste0(sp,"_PM_nest")), stat='P100', ylims=c(0,1.1), refline2=0.5)
  PlotRelPM(sp, calc='rd', Pstat='P100',
            baserefline=1, refline=0,
            maxylim=c(1.1, 10, 0.1, 1, -0.0, 1, 1, 2, 5, 4, 5), #VS
            minylim=c(0, rep(-1.05,10)) ) ## PLEASE NOTE THAT OUTLIERS HAVE BEEN CUT OFF

```
#### Fishing mortality metrics
```{r VS-F-PM, echo=FALSE, warning=FALSE, fig.height=7, fig.width=9, fig.cap = "OM-specific MP fishing mortality performance"}

par(mfrow=c(3,4), mar=c(2.4, 2.4, 0.2, 0.2), mgp=c(1.1, 0.25, 0), tck=-0.01, cex.axis=1)

myPlot_Violin(get(paste0(sp,"_PM_nest")), stat='trelF', ylimsEpiM=c(0,4))
 PlotRelPM(sp, calc='rd', Pstat='trelF',
            baserefline=1, refline=0,
            maxylim=c(3.5, 1.5, 15, 2, 15, 1.5, 4, 20, 10, 20, 15), #VS
            minylim=c(0, rep(-1.05,10)) ) ## PLEASE NOTE THAT OUTLIERS HAVE BEEN CUT OFF

myPlot_Violin(get(paste0(sp,"_PM_nest")), stat='t10relF', ylimsEpiM=c(0,4))
  PlotRelPM(sp, calc='rd', Pstat='t10relF',           ### NOTE THAT relF is arbitrarily set to 100 where F/FMSY == INF
            maxylim=c(3.5, 1.5, 15, 2, 15, 1, 4, 20, 10, 20, 15), #VS
            baserefline=1, refline=0,
            minylim=c(0, rep(-1.05,10)) ) ## PLEASE NOTE THAT OUTLIERS HAVE BEEN CUT OFF
 
myPlot_Violin(get(paste0(sp,"_PM_nest")), stat='PNOF', ylims=c(0,1.1), refline2=0.5)
 PlotRelPM(sp, calc='rd', Pstat='PNOF',
            baserefline=1, refline=0,
            maxylim=c(1.1, 5, 0.2, 1, 0.2, 2, 1, 1, 5, 4, 5), #VS
            minylim=c(0, rep(-1.05,10)) ) ## PLEASE NOTE THAT OUTLIERS HAVE BEEN CUT OFF



```

#### Yield metrics
```{r VS-yield-plots, echo=FALSE, fig.height=7, fig.width=9, fig.cap = "OM-specific MP yield performance"}

par(mfrow=c(3,4), mar=c(2.4, 2.4, 0.2, 0.2), mgp=c(1.1, 0.25, 0), tck=-0.01, cex.axis=1)

myPlot_Violin(get(paste0(sp,"_PM_nest")), stat='AAVY', ylims=c(0,1), refline2=0.3)
myPlot_Violin(get(paste0(sp,"_PM_nest")), stat='tyield', ylims=c(0,3))
myPlot_Violin(get(paste0(sp,"_PM_nest")), stat='cyield', refline2=50, ylims=c(0,150))
 PlotRelPM(sp, calc='rd', Pstat='cyield',
            baserefline=1, refline=0,
            maxylim=c(100, 0, 3.5,    1, 1.5, 0.1, 3,   1,  1, 2, 1.5), #VS
            minylim=c(0, -0.75, 0, -0.5,  0, -0.4, -1, -1, -1, -1, -1) ) ## PLEASE NOTE THAT OUTLIERS HAVE BEEN CUT OFF

```

#### Cumulative Performance Metrics
```{r VS-cumulative-PM-plot, echo=FALSE, fig.height=5, fig.cap = "MP performance across OMs"}

par(mfrow=c(2,3), mar=c(2.4, 2.4, 0.2, 0.2), mgp=c(1.1, 0.25, 0), tck=-0.01, cex.axis=1)
reflinetemp<-get(sp)[[1]]@OM$SSBMSY_SSB0[1]
PlotCumPM(sp, Pstat="AAVY", refline=c(0.3), title=species, ylims=c(0,1)) 
PlotCumPM(sp, Pstat="PNOF", refline=c(0.5), title=species, ylims=c(0,1.1))
PlotCumPM(sp, Pstat="P100", refline=c(0.5), title=species, ylims=c(0,1.1))
PlotCumPM(sp, Pstat="treldSSB0", ylim=c(0,1.1), refline=c(1, reflinetemp), title=species)
PlotCumPM(sp, Pstat="t10reldSSB0", ylim=c(0,1.1), refline=c(1, reflinetemp), title=species)
PlotCumPM(sp, Pstat="cyield",  refline=c(50), title=species, ylims=c(0, 150))
```

#### Trade off plots
```{r VS-trade-off-plots, echo=FALSE, fig.height=5, fig.cap = "MP performance across OMs"}
### Tradeoff plot
spp_pm<-get(paste(sp, "PM", sep="_"))

par(mfrow=c(1,2), mar=c(2.4, 2.4, 0.2, 0.2), mgp=c(1.1, 0.25, 0), tck=-0.01, cex.axis=1)
reflinetemp<-get(sp)[[1]]@OM$SSBMSY_SSB0[1]
TOff_Plot(SPP_PM=spp_pm, PMy='PNOF', PMx='cyield', errbars=F); abline(h=0.7, lty=3); abline(v=50, lty=2)
TOff_Plot(SPP_PM=spp_pm, PMy='t10reldSSB0', PMx='AAVY', errbars=F); abline(h=reflinetemp, lty=2); abline(v=0.3, lty=2)


```


#### Worm plots
```{r VS-worm-plots, echo=FALSE, fig.height=5, fig.cap = "MP performance across OMs"}
nms<-get(sp)$base@MPs
# cbind(MP_namesR_leg,orderedMPs)
mpnms<-nms[c(1,7,8)]
# names(get(sp))

# par(mfrow=c(1,4))
# myWorm(sp, OM="base", MPs=mpnms, metric="SB_SBMSY")
par(mfrow=c(3,3), oma=c(0,1.2,1.2,0), mar=c(2.4, 2.4, 0.2, 0.2), mgp=c(1.1, 0.25, 0), tck=-0.01, cex.axis=1)
myWorm(sp, OM="base", MPs=mpnms, metric="SB_SBMSY", nworms=9)
mtext(species, 3, outer=TRUE, line=-0.3)
par(mfrow=c(3,3), oma=c(0,0,1.2,0), mar=c(2.4, 3.4, 0.2, 0.2), mgp=c(1.1, 0.25, 0), tck=-0.01, cex.axis=1)
myWorm(sp, OM="base", MPs=mpnms, metric="SB_SBMSY", byMP=T, nworms=5)
myWorm(sp, OM="recdev_lo", MPs=mpnms, metric="SB_SBMSY", byMP=T, nworms=5)
myWorm(sp, OM="epiM", MPs=mpnms, metric="SB_SBMSY", byMP=T, nworms=5)
mtext(species, 3, outer=TRUE, line=0)


```


